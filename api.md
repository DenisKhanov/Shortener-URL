
# HTTP API

## Сервис расчета баллов лояльности

Сервис расчета баллов лояльности предоставляет следующее HTTP API.

### Получение информации о расчёте начислений

Получение информации о расчёте начислений баллов лояльности за совершённый заказ. Номер заказа должен представлять собой цифровую последовательность, удовлетворяющую [алгоритму Луна](https://en.wikipedia.org/wiki/Luhn_algorithm).

Формат запроса:
```
GET /api/orders/{number} HTTP/1.1
Content-Length: 0
```
Возможные коды ответа:
- `200` - пользователь успешно аутентифицирован
- `204` - заказ не зарегистрирован в системе расчёта
- `429` - превышено количество запросов к сервису
- `500` - внутренняя ошибка сервера

Формат успешного ответа:
```
200 OK HTTP/1.1
Content-Type: application/json
...

{
   "order": "<number>",
   "status": "PROCESSED",
   "accrual": 500
}
```
Поля объекта ответа:
- `order` - номер заказа
- `status` - статус расчёта начисления:
   - `REGISTERED` - заказ зарегистрирован, но не начисление не рассчитано
   - `INVALID` - заказ не принят к расчёту, и вознаграждение не будет начислено
   - `PROCESSING` - расчёт начисления в процессе
   - `PROCESSED` - расчёт начисления окончен
- `accrual` - рассчитанные баллы к начислению, при отсутствии начисления - поле отсутствует в ответе

Формат ответ при превышении числа запросов:
```
429 Too Many Requests HTTP/1.1
Content-Type: text/plain
Retry-After: 60

No more than N requests per minute allowed
```

### Регистрация нового совершённого заказа

Регистрация нового совершённого заказа. Для начисления баллов состав заказа должен проверяется на совпадения с зарегистрированными записями вознаграждений за товары. Начисляется сумма совпадений.

Формат запроса:
```
POST /api/orders HTTP/1.1
Content-Type: application/json

{
    "order": "<number>",
    "goods": [
        {
            "description": "Чайник Bork",
            "price": 7000
        },
        ...
    ]
}
```
Поля объекта запроса:
- `order` - номер заказа
- `goods` - список купленых товаров
- `description` - наименование товара
- `price` - цена оплаченного товара

Возможные коды ответа:
- `202` - заказ успешно принят в обработку
- `400` - неверный формат запроса
- `409` - заказ уже принят в обработку
- `500` - внутренняя ошибка сервера

### Регистрация информации о новой механике вознаграждения за товар

Регистрация информации о вознаграждении за товар. Хендлер используется менеджерами для добавления механик вознаграждения за покупки. Полученные системой расчёта начислений составы чеков проверяются на совпадение с зарегистрированными в данном хендлере вознаграждениями. Механика должна иметь уникальный ключ поиска (поле match).

Формат запроса:
```
POST /api/goods HTTP/1.1
Content-Type: application/json

{
    "match": "Bork",
    "reward": 10,
    "reward_type": "%"
}
```
Поля объекта запроса:
- `match` - ключ поиска (проверяется на наличие в строке наименования товара), не может быть пустым;
- `reward` - размер вознаграждения;
- `reward_type` - тип вознаграждения:
   - `%` - процент от стоимости товара;
   - `pt` - точное количество баллов.

Возможные коды ответа:
- `202` - вознаграждение успешно зарегистрировано
- `400` - неверный формат запроса
- `409` - ключ поиска уже зарегистрирован
- `500` - внутренняя ошибка сервера

## Сервис начисления баллов лояльности

Сервис начисления баллов лояльности предоставляет следующее HTTP API.

### Регистрация пользователя

Регистрация производится по паре логин/пароль. Каждый логин должен быть уникальным. После успешной регистрации должна происходить автоматическая аутентификация пользователя. Для передачи аутентификационных данных используется механизм cookie, в которой хранится JWT. 

Формат запроса:
```
POST /api/user/register HTTP/1.1
Content-Type: application/json
...

{
    "login": "<login>",
    "password": "<password>"
} 
````
Поля объекта запроса:
- `login` - логин пользователя
- `password` - пароль пользователя

Возможные коды ответа:
- `200` - пользователь успешно зарегистрирован и аутентифицирован
- `400` - неверный формат запроса
- `409` - логин уже занят
- `500` - внутренняя ошибка сервера

### Аутентификация пользователя

Аутентификация производится по паре логин/пароль. Для передачи аутентификационных данных используется механизм cookie, в которой хранится JWT.

Пример запроса:
```
POST /api/user/login HTTP/1.1
Content-Type: application/json
...

{
    "login": "<login>",
    "password": "<password>"
} 
```
Поля объекта запроса:
- `login` - логин пользователя
- `password` - пароль пользователя

Возможные коды ответа:
- `200` - пользователь успешно аутентифицирован
- `400` - неверный формат запроса
- `401` - неверная пара логин/пароль
- `500` - внутренняя ошибка сервера

### Загрузка номера заказа

Загрузка пользователем номера заказа для расчёта. Эндпоинт доступен только аутентифицированным пользователям. Номер заказа должен представлять собой цифровую последовательность, удовлетворяющую [алгоритму Луна](https://en.wikipedia.org/wiki/Luhn_algorithm).

Пример запроса:
```
POST /api/user/orders HTTP/1.1
Content-Type: text/plain
...

12345678903
```
Возможные коды ответа:
- `200` - номер заказа уже был загружен этим пользователем
- `202` - новый номер заказа принят в обработку
- `400` - неверный формат запроса
- `401` - пользователь не аутентифицирован
- `409` - номер заказа уже был загружен другим пользователем
- `422` - неверный формат номера заказа
- `500` - внутренняя ошибка сервера

### Получение списка загруженных номеров заказов

Получение списка загруженных пользователем номеров заказов, статусов их обработки и информации о начислениях. Эндпоинт доступен только аутентифицированным пользователям. Номера заказа в выдаче сортируются по времени загрузки от самых старых к самым новым. Формат даты - RFC3339.

Пример запроса:
```
GET /api/user/orders HTTP/1.1
Content-Length: 0 
```
Возможные коды ответа:
- `200` - успешная обработка запроса
- `204` - нет данных для ответа
- `401` - пользователь не авторизован
- `500` - внутренняя ошибка сервера

Формат успешного ответа:
```
200 OK HTTP/1.1
Content-Type: application/json
...

[
   {
         "number": "9278923470",
         "status": "PROCESSED",
         "accrual": 500,
         "uploaded_at": "2020-12-10T15:15:45+03:00"
   },
   {
         "number": "12345678903",
         "status": "PROCESSING",
         "uploaded_at": "2020-12-10T15:12:01+03:00"
   },
   {
         "number": "346436439",
         "status": "INVALID",
         "uploaded_at": "2020-12-09T16:09:53+03:00"
   }
]
```
Поля объекта ответа:
- `number` - номер заказа
- `status` - статус обработки расчётов:
   - `NEW` - заказ загружен в систему, но не попал в обработку
   - `PROCESSING` - вознаграждение за заказ рассчитывается
   - `INVALID` - система расчёта вознаграждений отказала в расчёте
   - `PROCESSED` - данные по заказу проверены и информация о расчёте успешно получена
- `accrual` - начисленные баллы, при отсутствии начисления - поле отсутствует в ответе
- `uploaded_at` - дата загрузки номера заказа


### Получение текущего баланса пользователя

Получение текущего баланса счёта баллов лояльности пользователя. Эндпоинт доступен только аутентифицированным пользователям. Ответ содержит данные о текущей сумме баллов лояльности, а также сумме использованных за весь период регистрации баллов.

Формат запроса:
```
GET /api/user/balance HTTP/1.1
Content-Length: 0 
```
Возможные коды ответа:
- `200` - успешная обработка запроса
- `401` - пользователь не авторизован
- `500` - внутренняя ошибка сервера

Формат успешного ответа:
```
200 OK HTTP/1.1
Content-Type: application/json
...

{
   "current": 500.5,
   "withdrawn": 42
}
```
Поля объекта ответа:
- `current` - текущий баланс баллов пользователя
- `withdrawn` - сумма использованных за весь период регистрации баллов

### Запрос на списание средств

Запрос на списание баллов с накопительного счёта в счёт оплаты нового заказа. Эндпоинт доступен только аутентифицированным пользователям. Номер заказа должен представлять собой цифровую последовательность, удовлетворяющую [алгоритму Луна](https://en.wikipedia.org/wiki/Luhn_algorithm).

Формат запроса:
```
POST /api/user/balance/withdraw HTTP/1.1
Content-Type: application/json

{
    "order": "2377225624",
    "sum": 751
}
```
Поля объекта запроса:
- `order` - номер заказа
- `sum` - сумма баллов к списанию в счёт оплаты

Возможные коды ответа:
- 200 - успешная обработка запроса
- 401 - пользователь не авторизован
- 402 - на счету недостаточно средств
- 422 - неверный номер заказа
- 500 - внутренняя ошибка сервера

### Получение информации о выводе средств

Получение информации о выводе средств с накопительного счёта пользователем. Эндпоинт доступен только аутентифицированным пользователям. Факты выводов в выдаче сортируются по времени вывода от самых старых к самым новым. Формат даты - RFC3339.

Формат запроса:
```
GET /api/user/withdrawals HTTP/1.1
Content-Length: 0
```
Возможные коды ответа:
- 200 - успешная обработка запроса
- 204 - нет данных для ответа
- 401 - пользователь не авторизован
- 500 - внутренняя ошибка сервера

Формат успешного ответа:
```
200 OK HTTP/1.1
Content-Type: application/json
...

[
   {
         "order": "2377225624",
         "sum": 500,
         "processed_at": "2020-12-09T16:09:57+03:00"
   }
]
```
Поля объекта ответа:
- `order` - номер заказа в счет которого выполнялось списание
- `sum` - сумма баллов, списанная в счёт оплаты
- `processed_at` - дата списания
